{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "GPT‑Review Patch (v3)",
  "description": "Canonical schema for every JSON patch that ChatGPT must return.",
  "$comment": "Two fields are always required: op (operation) and status.",
  "type": "object",
  "required": ["op", "status"],
  "additionalProperties": false,
  "properties": {
    "op": {
      "type": "string",
      "enum": ["create", "update", "delete", "rename", "chmod"],
      "description": "Filesystem action to perform on the repository."
    },
    "file": {
      "type": "string",
      "description": "Path of the source file, *relative to repo root*."
    },
    "body": {
      "type": "string",
      "description": "Full UTF‑8 text contents when creating or updating a **text** file."
    },
    "body_b64": {
      "type": "string",
      "description": "Base64‑encoded bytes when creating or updating a **binary** file."
    },
    "target": {
      "type": "string",
      "description": "Destination path when op = rename."
    },
    "mode": {
      "type": "string",
      "pattern": "^[0-7]{3,4}$",
      "description": "Octal permission bits when op = chmod (accepts 3‑ or 4‑digit forms, e.g. \"755\" or \"0755\")."
    },
    "status": {
      "type": "string",
      "enum": ["in_progress", "completed"],
      "description": "in_progress → more patches will follow; completed → task done."
    }
  },
  "allOf": [
    {
      "$comment": "create & update need file plus exactly one of body/body_b64",
      "if": { "properties": { "op": { "enum": ["create", "update"] } } },
      "then": {
        "oneOf": [
          { "required": ["file", "body"], "not": { "required": ["body_b64"] } },
          { "required": ["file", "body_b64"], "not": { "required": ["body"] } }
        ]
      }
    },
    {
      "$comment": "delete requires only the source path",
      "if": { "properties": { "op": { "const": "delete" } } },
      "then": { "required": ["file"] }
    },
    {
      "$comment": "rename requires both source and target paths",
      "if": { "properties": { "op": { "const": "rename" } } },
      "then": { "required": ["file", "target"] }
    },
    {
      "$comment": "chmod requires source path and octal mode (applier accepts 3‑ or 4‑digit forms; safe list enforced in code)",
      "if": { "properties": { "op": { "const": "chmod" } } },
      "then": { "required": ["file", "mode"] }
    }
  ]
}
